{% extends 'home/base.html' %}
{% load static %}

{% block title %}Inicio{% endblock %}

{% block content %}
    <div>
        <h2>¡Realiza tu reserva online!</h2>
        <div>
            <style>
                .menu-reservas {
                    background-color: rgb(60, 107, 60);
                    text-align: center;
                    border-radius: 30px;
                    padding: 30px;
                    max-width: 600px;
                    margin: 0 auto;
                }
                .menu-reservas .form-group {
                    display: flex;
                    align-items: center;
                    justify-content: flex-start;
                    margin: 15px 0;
                    padding: 0 20px;
                    gap: 15px;
                }
                .menu-reservas label {
                    min-width: 180px;
                    text-align: right;
                    color: white;
                    font-weight: 500;
                }
                .menu-reservas select {
                    flex: 1;
                    max-width: 250px;
                    padding: 8px;
                    border-radius: 4px;
                    border: 1px solid #ccc;
                    font-size: 14px;
                }
                .menu-reservas input[type="date"] {
                    flex: 1;
                    max-width: 250px;
                    padding: 8px;
                    border-radius: 4px;
                    border: 1px solid #ccc;
                    font-size: 14px;
                }
                .menu-reservas input[type="text"] {
                    flex: 1;
                    max-width: 250px;
                    padding: 8px;
                    border-radius: 4px;
                    border: 1px solid #ccc;
                    font-size: 14px;
                }
                .menu-reservas .form-group:first-child {
                    justify-content: flex-start;
                    padding-left: 20px;
                }
                .menu-reservas .form-group:first-child label {
                    min-width: auto;
                    text-align: left;
                }
                .menu-reservas .form-group:last-child {
                    justify-content: center;
                }
                .menu-reservas .btn-primary {
                    margin-top: 20px;
                    padding: 10px 30px;
                    font-size: 16px;
                }
                .menu-reservas select option {
                    padding: 5px;
                }
            </style>
            <fieldset class="menu-reservas">
                <form method="POST" action="{% url 'home:buscar_vehiculos' %}">
                    {% csrf_token %}
                    <div class="form-group" style="justify-content: flex-start;">
                        <input type="checkbox" id="misma_sucursal" name="misma_sucursal" checked style="margin-right: 10px;">
                        <label for="misma_sucursal">Misma sucursal de retiro y devolución</label>
                    </div>
                    <div class="form-group">
                        <label>Sucursal de retiro</label>
                        <select id="sucursal_retiro" name="sucursal_retiro" class="form-select" required>
                            <option value="">Seleccione una sucursal</option>
                            {% for sucursal in sucursales %}
                                <option value="{{ sucursal.id }}" {% if sucursal.id|stringformat:"i" == sucursal_seleccionada %}selected{% endif %}>
                                    {{ sucursal.nombre }} - {{ sucursal.direccion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group" id="sucursal_devolucion_group" style="display: none;">
                        <label>Sucursal de devolución</label>
                        <select id="sucursal_devolucion" name="sucursal_devolucion" class="form-select">
                            <option value="">Seleccione una sucursal</option>
                            {% for sucursal in sucursales %}
                                <option value="{{ sucursal.id }}" {% if sucursal.id|stringformat:"i" == sucursal_seleccionada %}selected{% endif %}>
                                    {{ sucursal.nombre }} - {{ sucursal.direccion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Retiro</label>
                        <input type="date" id="fechaRetiro" name="fecha_retiro" value="{{ fecha_retiro|date:'Y-m-d' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Entrega</label>
                        <input type="date" id="fechaEntrega" name="fecha_entrega" value="{{ fecha_entrega|date:'Y-m-d' }}" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Buscar Vehículos Disponibles</button>
                    </div>
                </form>
            </fieldset>

            <script>
                const hoy = new Date().toISOString().split('T')[0];
                const fechaRetiro = document.getElementById('fechaRetiro');
                const fechaEntrega = document.getElementById('fechaEntrega');
                const mismaSucursal = document.getElementById('misma_sucursal');
                const sucursalRetiro = document.getElementById('sucursal_retiro');
                const sucursalDevolucion = document.getElementById('sucursal_devolucion');
                const sucursalDevolucionGroup = document.getElementById('sucursal_devolucion_group');

                // Configuración inicial de fechas
                fechaRetiro.min = hoy;
                fechaEntrega.min = hoy;

                // Manejo de fechas
                fechaRetiro.addEventListener('change', function () {
                    const fechaSeleccionada = fechaRetiro.value;
                    fechaEntrega.min = fechaSeleccionada;
                    if (fechaEntrega.value && fechaEntrega.value < fechaSeleccionada) {
                        fechaEntrega.value = "";
                    }
                });

                // Manejo de sucursal de devolución
                mismaSucursal.addEventListener('change', function() {
                    if (this.checked) {
                        sucursalDevolucionGroup.style.display = 'none';
                        sucursalDevolucion.value = sucursalRetiro.value;
                    } else {
                        sucursalDevolucionGroup.style.display = 'flex';
                    }
                });

                // Sincronizar sucursal de devolución cuando cambia la de retiro
                sucursalRetiro.addEventListener('change', function() {
                    if (mismaSucursal.checked) {
                        sucursalDevolucion.value = this.value;
                    }
                });
            </script>
            <br><br><br><br><br>
            <hr>
        </div>
    </div>

    <div class="lista autos fondo">
        {% if vehiculos_disponibles %}
            <h3>Vehículos Disponibles</h3>
            <div class="row">
                {% for vehiculo in vehiculos_disponibles %}
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">{{ vehiculo.marca }} {{ vehiculo.modelo }}</h5>
                                <p class="card-text">
                                    <strong>Año:</strong> {{ vehiculo.año }}<br>
                                    <strong>Patente:</strong> {{ vehiculo.patente }}<br>
                                    <strong>Precio por día:</strong> ${{ vehiculo.precio_por_dia|floatformat:2 }}<br>
                                    <strong>Ubicación:</strong> {{ vehiculo.sucursal_actual.nombre }}
                                </p>
                                <a href="{% url 'reservas:crear_reserva' vehiculo.id %}?fecha_retiro={{ fecha_retiro|date:'Y-m-d' }}&fecha_entrega={{ fecha_entrega|date:'Y-m-d' }}" 
                                   class="btn btn-primary">Reservar este vehículo</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            {% if request.method == 'POST' %}
                <h3>No hay vehículos disponibles para los criterios seleccionados</h3>
            {% endif %}
        {% endif %}
    </div>
{% endblock %}