{% extends 'home/base.html' %}
{% load static %}

{% block title %}Buscar Vehículos{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Buscar Vehículos Disponibles</h2>
    
    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <div class="card shadow-lg mb-4">
        <div class="card-body">
            <form method="POST" action="{% url 'home:buscar_vehiculos' %}">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="misma_sucursal" name="misma_sucursal" checked>
                            <label class="form-check-label" for="misma_sucursal">Misma sucursal de retiro y devolución</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sucursal_retiro" class="form-label">Sucursal de retiro</label>
                            <select id="sucursal_retiro" name="sucursal_retiro" class="form-select" required>
                                <option value="">Seleccione una sucursal</option>
                                {% for sucursal in sucursales %}
                                    <option value="{{ sucursal.id }}" {% if sucursal.id|stringformat:"i" == sucursal_seleccionada %}selected{% endif %}>
                                        {{ sucursal.nombre }} - {{ sucursal.direccion }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3" id="sucursal_devolucion_group" style="display: none;">
                            <label for="sucursal_devolucion" class="form-label">Sucursal de devolución</label>
                            <select id="sucursal_devolucion" name="sucursal_devolucion" class="form-select">
                                <option value="">Seleccione una sucursal</option>
                                {% for sucursal in sucursales %}
                                    <option value="{{ sucursal.id }}" {% if sucursal.id|stringformat:"i" == sucursal_seleccionada %}selected{% endif %}>
                                        {{ sucursal.nombre }} - {{ sucursal.direccion }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="fechaRetiro" class="form-label">Fecha de Retiro</label>
                            <input type="date" class="form-control" id="fechaRetiro" name="fecha_retiro" 
                                   value="{{ fecha_retiro|date:'Y-m-d' }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="fechaEntrega" class="form-label">Fecha de Entrega</label>
                            <input type="date" class="form-control" id="fechaEntrega" name="fecha_entrega" 
                                   value="{{ fecha_entrega|date:'Y-m-d' }}" required>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-primary btn-lg">Buscar Vehículos Disponibles</button>
                </div>
            </form>
        </div>
    </div>

    {% if vehiculos_disponibles %}
        <h3 class="mb-4">Vehículos Disponibles</h3>
        <div class="row">
            {% for vehiculo in vehiculos_disponibles %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ vehiculo.marca }} {{ vehiculo.modelo }}</h5>
                            <p class="card-text">
                                <strong>Año:</strong> {{ vehiculo.año }}<br>
                                <strong>Patente:</strong> {{ vehiculo.patente }}<br>
                                <strong>Precio por día:</strong> ${{ vehiculo.precio_por_dia|floatformat:2 }}<br>
                                <strong>Ubicación:</strong> {{ vehiculo.sucursal_actual.nombre }}
                            </p>
                            <a href="{% url 'reservas:crear_reserva' vehiculo.id %}?fecha_retiro={{ fecha_retiro }}&fecha_entrega={{ fecha_entrega }}" 
                               class="btn btn-primary w-100">Reservar este vehículo</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% elif request.method == 'POST' %}
        <div class="alert alert-info" role="alert">
            No hay vehículos disponibles para los criterios seleccionados
        </div>
    {% endif %}
</div>

<script>
    const hoy = new Date().toISOString().split('T')[0];
    const fechaRetiro = document.getElementById('fechaRetiro');
    const fechaEntrega = document.getElementById('fechaEntrega');
    const mismaSucursal = document.getElementById('misma_sucursal');
    const sucursalRetiro = document.getElementById('sucursal_retiro');
    const sucursalDevolucion = document.getElementById('sucursal_devolucion');
    const sucursalDevolucionGroup = document.getElementById('sucursal_devolucion_group');

    // Configuración inicial de fechas
    fechaRetiro.min = hoy;
    fechaEntrega.min = hoy;

    // Manejo de fechas
    fechaRetiro.addEventListener('change', function () {
        const fechaSeleccionada = fechaRetiro.value;
        fechaEntrega.min = fechaSeleccionada;
        if (fechaEntrega.value && fechaEntrega.value < fechaSeleccionada) {
            fechaEntrega.value = "";
        }
    });

    // Manejo de sucursal de devolución
    mismaSucursal.addEventListener('change', function() {
        if (this.checked) {
            sucursalDevolucionGroup.style.display = 'none';
            sucursalDevolucion.value = sucursalRetiro.value;
        } else {
            sucursalDevolucionGroup.style.display = 'block';
        }
    });

    // Sincronizar sucursal de devolución cuando cambia la de retiro
    sucursalRetiro.addEventListener('change', function() {
        if (mismaSucursal.checked) {
            sucursalDevolucion.value = this.value;
        }
    });
</script>
{% endblock %} 