{% extends 'home/base.html' %}
{% load static %}

{% block title %}Buscar Vehículos{% endblock %}

{% block content %}
<style>
    .sucursal-devolucion-hidden {
        display: none;
    }
    .sucursal-devolucion-visible {
        display: block;
    }
</style>

<div class="container">
    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header text-white" style="background-color: #0e4532;">
                    <h2 class="mb-0 text-center">Buscar Vehículos Disponibles</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{% url 'home:buscar_vehiculos' %}">
                        {% csrf_token %}
                        <div class="form-group mb-3" style="display: flex; align-items: center;">
                            <input type="checkbox" id="misma_sucursal" name="misma_sucursal" 
                                   {% if misma_sucursal %}checked{% endif %} style="margin-right: 10px;">
                            <label for="misma_sucursal" class="mb-0">Misma sucursal de retiro y devolución</label>
                        </div>

                        <div class="form-group mb-3">
                            <label for="sucursal_retiro" class="form-label">Sucursal de retiro</label>
                            <select id="sucursal_retiro" name="sucursal_retiro" class="form-select" required>
                                <option value="">Seleccione una sucursal</option>
                                {% for sucursal in sucursales %}
                                    <option value="{{ sucursal.id }}" 
                                            {% if sucursal.id|stringformat:"i" == sucursal_seleccionada %}selected{% endif %}>
                                        {{ sucursal.nombre }} - {{ sucursal.direccion }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group mb-3 {% if misma_sucursal %}sucursal-devolucion-hidden{% else %}sucursal-devolucion-visible{% endif %}" id="sucursal_devolucion_group">
                            <label for="sucursal_devolucion" class="form-label">Sucursal de devolución</label>
                            <select id="sucursal_devolucion" name="sucursal_devolucion" class="form-select">
                                <option value="">Seleccione una sucursal</option>
                                {% for sucursal in sucursales %}
                                    <option value="{{ sucursal.id }}" 
                                            {% if sucursal.id|stringformat:"i" == sucursal_devolucion_seleccionada %}selected{% endif %}>
                                        {{ sucursal.nombre }} - {{ sucursal.direccion }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="fechaRetiro" class="form-label">Fecha de Retiro</label>
                                    <input type="date" id="fechaRetiro" name="fecha_retiro" class="form-control" 
                                           value="{{ fecha_retiro|date:'Y-m-d' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="fechaEntrega" class="form-label">Fecha de Entrega</label>
                                    <input type="date" id="fechaEntrega" name="fecha_entrega" class="form-control" 
                                           value="{{ fecha_entrega|date:'Y-m-d' }}" required>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-lg text-white" style="background-color: #0e4532;">
                                Buscar Vehículos
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if vehiculos_disponibles %}
        <h3 class="mb-4">Vehículos Disponibles</h3>
        <div class="row">
            {% for vehiculo in vehiculos_disponibles %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ vehiculo.marca }} {{ vehiculo.modelo }}</h5>
                            <p class="card-text">
                                <strong>Año:</strong> {{ vehiculo.año }}<br>
                                <strong>Patente:</strong> {{ vehiculo.patente }}<br>
                                <strong>Precio por día:</strong> ${{ vehiculo.precio_por_dia|floatformat:2 }}<br>
                                <strong>Ubicación:</strong> {{ vehiculo.sucursal_actual.nombre }}
                            </p>
                            <a href="{% url 'reservas:crear_reserva' vehiculo.id %}?fecha_retiro={{ fecha_retiro|date:'Y-m-d' }}&fecha_entrega={{ fecha_entrega|date:'Y-m-d' }}" 
                               class="btn btn-primary w-100">Reservar este vehículo</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% elif request.method == 'POST' %}
        <div class="alert alert-info" role="alert">
            No hay vehículos disponibles para los criterios seleccionados
        </div>
    {% endif %}
</div>

<script>
    const hoy = new Date().toISOString().split('T')[0];
    const fechaRetiro = document.getElementById('fechaRetiro');
    const fechaEntrega = document.getElementById('fechaEntrega');
    const mismaSucursal = document.getElementById('misma_sucursal');
    const sucursalRetiro = document.getElementById('sucursal_retiro');
    const sucursalDevolucion = document.getElementById('sucursal_devolucion');
    const sucursalDevolucionGroup = document.getElementById('sucursal_devolucion_group');

    // Configuración inicial de fechas
    fechaRetiro.min = hoy;
    fechaEntrega.min = hoy;

    // Manejo de fechas
    fechaRetiro.addEventListener('change', function () {
        const fechaSeleccionada = fechaRetiro.value;
        fechaEntrega.min = fechaSeleccionada;
        if (fechaEntrega.value && fechaEntrega.value < fechaSeleccionada) {
            fechaEntrega.value = "";
        }
    });

    // Manejo de sucursal de devolución
    mismaSucursal.addEventListener('change', function() {
        if (this.checked) {
            sucursalDevolucionGroup.classList.remove('sucursal-devolucion-visible');
            sucursalDevolucionGroup.classList.add('sucursal-devolucion-hidden');
            sucursalDevolucion.value = sucursalRetiro.value;
        } else {
            sucursalDevolucionGroup.classList.remove('sucursal-devolucion-hidden');
            sucursalDevolucionGroup.classList.add('sucursal-devolucion-visible');
        }
    });

    // Sincronizar sucursal de devolución cuando cambia la de retiro
    sucursalRetiro.addEventListener('change', function() {
        if (mismaSucursal.checked) {
            sucursalDevolucion.value = this.value;
        }
    });
</script>
{% endblock %} 